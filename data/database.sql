DROP TABLE IF EXISTS TIPO;
CREATE TABLE TIPO (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    CODIGO INTEGER NOT NULL UNIQUE,
    CODIGO_FIEBFDC INTEGER NOT NULL,
    DESCRIPCION INTEGER NOT NULL
);
INSERT INTO TIPO (ID, CODIGO, CODIGO_FIEBFDC, DESCRIPCION) VALUES (0, 'MO', 1, 'MANO DE OBRA');
INSERT INTO TIPO (ID, CODIGO, CODIGO_FIEBFDC, DESCRIPCION) VALUES (1, 'MQ', 2, 'MAQUINARIA');
INSERT INTO TIPO (ID, CODIGO, CODIGO_FIEBFDC, DESCRIPCION) VALUES (2, 'MA', 3, 'MATERIALES');
INSERT INTO TIPO (ID, CODIGO, CODIGO_FIEBFDC, DESCRIPCION) VALUES (3, '%%', 0, 'AUXILIARES');
INSERT INTO TIPO (ID, CODIGO, CODIGO_FIEBFDC, DESCRIPCION) VALUES (4, 'PA', 0, 'PARTIDA UNITARIA');
DROP TABLE IF EXISTS UNIDAD;
CREATE TABLE UNIDAD (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    CODIGO TEXT NOT NULL UNIQUE,
    DESCRIPCION TEXT NOT NULL
);
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (0, 'm', 'metro');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (1, 'm2', 'metro cuadrado');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (2, 'm3', 'metro cúbico');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (3, 'kg', 'kilogramo');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (4, 'km', 'kilómetro');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (5, 't', 'tonelada');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (6, 'l', 'litro');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (7, 'h', 'hora');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (8, 'd', 'día');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (9, 'a', 'área');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (10, 'ha', 'hectárea');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (11, 'cm3', 'centímetro cúbico');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (12, 'cm2', 'centímetro cuadrado');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (13, 'dm3', 'decímetro cúbico');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (14, 'u', 'unidad');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (15, 'mu', 'mil unidades');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (16, 'cu', 'cien unidades');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (17, 'mes', 'mes');
INSERT INTO UNIDAD (ID, CODIGO, DESCRIPCION) VALUES (18, '€', 'euro');
DROP TABLE IF EXISTS TIPO_PRECIO;
CREATE TABLE TIPO_PRECIO (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    CODIGO TEXT NOT NULL UNIQUE,
    DESCRIPCION TEXT
);
INSERT INTO TIPO_PRECIO (ID, CODIGO, DESCRIPCION) VALUES (0, 'v', 'venta');
INSERT INTO TIPO_PRECIO (ID, CODIGO, DESCRIPCION) VALUES (1, 'c', 'coste');

DROP TABLE IF EXISTS PRECIO;
CREATE TABLE PRECIO (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    CONCEPTO_ID INTEGER NOT NULL,
    CODIGO TEXT NOT NULL UNIQUE,
    UNIDAD_ID INTEGER NOT NULL,
    RESUMEN TEXT,
    TEXTO TEXT,
    PRECIO REAL DEFAULT 1.0,
    FECHA TEXT,
    TIPO_ID INTEGER,
    TIPO_PRECIO_ID INTEGER,
    FOREIGN KEY(UNIDAD_ID) REFERENCES UNIDAD(ID),
    FOREIGN KEY(TIPO_ID) REFERENCES TIPO(ID),
    FOREIGN KEY(TIPO_PRECIO_ID) REFERENCES TIPO_PRECIO(ID),
    FOREIGN KEY(CONCEPTO_ID) REFERENCES CONCEPTO(ID),
    UNIQUE(CONCEPTO_ID, TIPO_PRECIO_ID),
    UNIQUE(CODIGO, TIPO_PRECIO_ID)
);
DROP TABLE IF EXISTS CONCEPTO;
CREATE TABLE CONCEPTO (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    CODIGO TEXT NOT NULL UNIQUE
);
DROP TABLE IF EXISTS DESCOMPOSICION;
CREATE TABLE DESCOMPOSICION (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    PRECIO_PADRE_ID INTEGER NOT NULL,
    PRECIO_HIJO_ID INTEGER NOT NULL,
    ORDEN INTEGER NOT NULL,
    FACTOR REAL DEFAULT 1.0,
    RENDIMIENTO REAL DEFAULT 1.0,
    FOREIGN KEY(PRECIO_PADRE_ID) REFERENCES PRECIO(ID),
    FOREIGN KEY(PRECIO_HIJO_ID) REFERENCES PRECIO(ID),
    UNIQUE (PRECIO_PADRE_ID, PRECIO_HIJO_ID),
    UNIQUE (PRECIO_PADRE_ID, PRECIO_HIJO_ID, ORDEN)
);
DROP TABLE IF EXISTS TIPO_MEDICION;
CREATE TABLE TIPO_MEDICION (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    ID_FIEBDC INTEGER NOT NULL UNIQUE,
    DESCRIPCION TEXT
);
INSERT INTO TIPO_MEDICION (ID, ID_FIEBDC, DESCRIPCION) VALUES (0, 0, 'defecto');
INSERT INTO TIPO_MEDICION (ID, ID_FIEBDC, DESCRIPCION) VALUES (1, 1, 'parcial');
INSERT INTO TIPO_MEDICION (ID, ID_FIEBDC, DESCRIPCION) VALUES (2, 2, 'subtotal');
INSERT INTO TIPO_MEDICION (ID, ID_FIEBDC, DESCRIPCION) VALUES (3, 3, 'fórmula');

DROP TABLE IF EXISTIS TIPO_VALORADA;
CREATE TABLE TIPO_VALORADA (
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    CODIGO TEXT NOT NULL UNIQUE,
    DESCRIPCION TEXT
);

INSERT INTO TIPO_VALORADA (ID, CODIGO, DESCRIPCION) VALUES (0, 'P', 'Proyecto');
INSERT INTO TIPO_VALORADA (ID, CODIGO, DESCRIPCION) VALUES (1, 'V', 'Valorada');
INSERT INTO TIPO_VALORADA (ID, CODIGO, DESCRIPCION) VALUES (2, 'M', 'Modificado');
INSERT INTO TIPO_VALORADA (ID, CODIGO, DESCRIPCION) VALUES (3, 'C', 'Complementario');
INSERT INTO TIPO_VALORADA (ID, CODIGO, DESCRIPCION) VALUES (4, 'E', 'Adicional');
INSERT INTO TIPO_VALORADA (ID, CODIGO, DESCRIPCION) VALUES (5, 'F', 'Fuera de contrato');

DROP TABLE IF EXISTS VALORADA;
CREATE TABLE VALORADA(
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    TIPO_VALORADA_ID INTEGER NOT NULL,
    FECHA TEXT NOT NULL UNIQUE,
    FOREIGN KEY(TIPO_VALORADA_ID) REFERENCES TIPO_VALORADA(ID),
    UNIQUE(TIPO_VALORADA_ID, FECHA)
);

DROP TABLE IF EXISTS MEDICION;
CREATE TABLE MEDICION(
    ID INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    VALORADA_ID INTEGER NOT NULL,
    PRECIO_ID INTEGER NOT NULL,
    POSICION INTEGER,
    MEDICION_TOTAL REAL,
    TIPO_MEDICION_ID INTEGER NOT NULL,
    COMENTARIO TEXT,
    CANTIDAD REAL,
    LARGO REAL,
    ANCHO REAL,
    ALTO REAL,
    FOREIGN KEY(VALORADA_ID) REFERENCES VALORADA(ID),
    FOREIGN KEY(PRECIO_ID) REFERENCES PRECIO(ID),
    FOREIGN KEY(TIPO_MEDICION_ID) REFERENCES TIPO_MEDICION(ID),
    UNIQUE (VALORADA_ID, PRECIO_ID, POSICION)
);

DROP VIEW IF EXISTS VENTA;
CREATE VIEW VENTA (CODIGO, TIPO, UNIDAD, RESUMEN, TEXTO, PRECIO) AS SELECT
    CONCEPTO.CODIGO,
    TIPO.CODIGO,
    UNIDAD.CODIGO,
    PRECIO.RESUMEN,
    PRECIO.TEXTO,
    PRECIO.PRECIO
FROM CONCEPTO
LEFT JOIN PRECIO ON
    PRECIO.CONCEPTO_ID=CONCEPTO.ID
LEFT JOIN TIPO ON
    PRECIO.TIPO_ID=TIPO.ID
LEFT JOIN TIPO_PRECIO ON
    PRECIO.TIPO_PRECIO_ID=TIPO_PRECIO.ID
LEFT JOIN UNIDAD ON
    PRECIO.UNIDAD_ID=UNIDAD.ID
WHERE PRECIO.TIPO_PRECIO_ID=0;

--TEST--

INSERT INTO CONCEPTO (ID, CODIGO) VALUES (0, 'C001');
INSERT INTO CONCEPTO (ID, CODIGO) VALUES (1, 'C002');
INSERT INTO CONCEPTO (ID, CODIGO) VALUES (2, 'C003');
INSERT INTO CONCEPTO (ID, CODIGO) VALUES (3, 'C004');
INSERT INTO CONCEPTO (ID, CODIGO) VALUES (4, 'C005');

INSERT INTO PRECIO (ID, CONCEPTO_ID, CODIGO, UNIDAD_ID, RESUMEN, TEXTO, PRECIO, FECHA, TIPO_ID, TIPO_PRECIO_ID)
            VALUES (0, 0, '001', 0, 'Ejemplo', 'Ejemplo', 123.45, '20170425', 0, 0);
INSERT INTO PRECIO (ID, CONCEPTO_ID, CODIGO, UNIDAD_ID, RESUMEN, TEXTO, PRECIO, FECHA, TIPO_ID, TIPO_PRECIO_ID)
            VALUES (1, 0, '002', 0, 'Ejemplo', 'Ejemplo', 123.45, '20170425', 0, 1);

